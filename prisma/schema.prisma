// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions         Session[]
  quizAttempts     QuizAttempt[]
  streak           UserStreak?
  examProgress     UserExamProgress[]
  subjectProgress  UserSubjectProgress[]
  chapterProgress  UserChapterProgress[]
  quizProgress     UserQuizProgress[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model Exam {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subjects     Subject[]
  userProgress UserExamProgress[]

  @@index([isActive])
  @@index([order])
  @@map("exams")
}

model Subject {
  id          String   @id @default(uuid())
  examId      String
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  exam         Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  chapters     Chapter[]
  userProgress UserSubjectProgress[]

  @@index([examId])
  @@index([isActive])
  @@index([order])
  @@map("subjects")
}

model Chapter {
  id          String   @id @default(uuid())
  subjectId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  quizzes       Quiz[]
  userProgress  UserChapterProgress[]

  @@index([subjectId])
  @@index([isActive])
  @@index([order])
  @@map("chapters")
}

model Quiz {
  id          String   @id @default(uuid())
  chapterId   String
  title       String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chapter      Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  questions    Question[]
  attempts     QuizAttempt[]
  userProgress UserQuizProgress[]

  @@index([chapterId])
  @@index([isActive])
  @@index([order])
  @@map("quizzes")
}

model Question {
  id            String   @id @default(uuid())
  quizId        String
  text          String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctAnswer String
  explanation   String?
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quiz      Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  responses QuestionResponse[]

  @@index([quizId])
  @@index([isActive])
  @@index([order])
  @@map("questions")
}

model QuizAttempt {
  id             String   @id @default(uuid())
  userId         String
  quizId         String
  score          Float
  totalQuestions Int
  correctAnswers Int
  completedAt    DateTime @default(now())
  createdAt      DateTime @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz      Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  responses QuestionResponse[]

  @@index([userId])
  @@index([quizId])
  @@index([completedAt])
  @@map("quiz_attempts")
}

model QuestionResponse {
  id            String   @id @default(uuid())
  attemptId     String
  questionId    String
  selectedAnswer String
  isCorrect     Boolean
  createdAt     DateTime @default(now())

  attempt  QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
  @@map("question_responses")
}

model UserStreak {
  id            String   @id @default(uuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastQuizDate  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_streaks")
}

model UserExamProgress {
  id               String   @id @default(uuid())
  userId           String
  examId           String
  totalSubjects    Int      @default(0)
  completedSubjects Int     @default(0)
  progress         Float    @default(0)
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([userId, examId])
  @@index([userId])
  @@index([examId])
  @@map("user_exam_progress")
}

model UserSubjectProgress {
  id               String   @id @default(uuid())
  userId           String
  subjectId        String
  totalChapters    Int      @default(0)
  completedChapters Int     @default(0)
  progress         Float    @default(0)
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId])
  @@index([userId])
  @@index([subjectId])
  @@map("user_subject_progress")
}

model UserChapterProgress {
  id              String   @id @default(uuid())
  userId          String
  chapterId       String
  totalQuizzes    Int      @default(0)
  completedQuizzes Int     @default(0)
  progress        Float    @default(0)
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@index([userId])
  @@index([chapterId])
  @@map("user_chapter_progress")
}

model UserQuizProgress {
  id            String   @id @default(uuid())
  userId        String
  quizId        String
  isCompleted   Boolean  @default(false)
  bestScore     Float?
  attemptCount  Int      @default(0)
  lastAttemptAt DateTime?
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([userId, quizId])
  @@index([userId])
  @@index([quizId])
  @@map("user_quiz_progress")
}
